const a71_0x45cdd1=a71_0x3781;function a71_0x3781(_0xf48f2c,_0x1bdd11){const _0x466fc1=a71_0x466f();return a71_0x3781=function(_0x3781a2,_0x564dc3){_0x3781a2=_0x3781a2-0x163;let _0x583595=_0x466fc1[_0x3781a2];return _0x583595;},a71_0x3781(_0xf48f2c,_0x1bdd11);}(function(_0x2571c4,_0x1792bd){const _0x2f630e=a71_0x3781,_0x83a0a8=_0x2571c4();while(!![]){try{const _0xbdfb80=-parseInt(_0x2f630e(0x169))/0x1*(-parseInt(_0x2f630e(0x197))/0x2)+-parseInt(_0x2f630e(0x192))/0x3+parseInt(_0x2f630e(0x195))/0x4+parseInt(_0x2f630e(0x16c))/0x5+-parseInt(_0x2f630e(0x16e))/0x6*(parseInt(_0x2f630e(0x19d))/0x7)+-parseInt(_0x2f630e(0x17a))/0x8*(parseInt(_0x2f630e(0x1a3))/0x9)+parseInt(_0x2f630e(0x189))/0xa;if(_0xbdfb80===_0x1792bd)break;else _0x83a0a8['push'](_0x83a0a8['shift']());}catch(_0xa178cd){_0x83a0a8['push'](_0x83a0a8['shift']());}}}(a71_0x466f,0xed688));const fs=require('fs'),path=require(a71_0x45cdd1(0x19b)),os=require('os'),{spawn}=require(a71_0x45cdd1(0x171)),helper=require(a71_0x45cdd1(0x198)),logger=require(a71_0x45cdd1(0x185))['winstonLogger'],{logDir}=require('../logger'),testHubConstants=require(a71_0x45cdd1(0x17f)),PerformanceTester=require('../../helpers/performance/performance-tester'),{PERCY_EVENTS:PerformanceEvents}=require('../../helpers/performance/constants'),PercyBinary=require(a71_0x45cdd1(0x1a6));class Percy{#logfile=path['join'](logDir,'percy.log');#address=process['env'][a71_0x45cdd1(0x165)]||a71_0x45cdd1(0x179);#binaryPath=null;#config=null;#proc=null;#isApp=![];['isProcessRunning']=![];constructor(_0x12e39a){const _0x3ff803=a71_0x45cdd1;this.#config=_0x12e39a,!!_0x12e39a[_0x3ff803(0x190)]&&(this.#isApp=!![]);}async #getBinaryPath(){const _0x2e42ec=a71_0x45cdd1;if(!this.#binaryPath){const _0x4181cf=new PercyBinary();PerformanceTester[_0x2e42ec(0x199)](PerformanceEvents[_0x2e42ec(0x16a)]),this.#binaryPath=await _0x4181cf['getBinaryPath'](this.#config),PerformanceTester['end'](PerformanceEvents[_0x2e42ec(0x16a)]);}return this.#binaryPath;}async #sleep(_0x6257d6){return new Promise(_0x1b22e8=>setTimeout(_0x1b22e8,_0x6257d6));}async[a71_0x45cdd1(0x1a5)](){const _0x870b2b=a71_0x45cdd1,_0xdcef4d={};_0xdcef4d[_0x870b2b(0x1a8)]=_0x870b2b(0x182),_0xdcef4d[_0x870b2b(0x18c)]=_0x870b2b(0x170);const _0x1a9cc6=_0xdcef4d;try{const _0x205fc4=await helper[_0x870b2b(0x1a9)](_0x1a9cc6[_0x870b2b(0x1a8)],_0x1a9cc6[_0x870b2b(0x18c)],null,null,this.#address);if(_0x205fc4)return!![];}catch(_0x1243ae){return![];}}async[a71_0x45cdd1(0x199)](){const _0x241a11=a71_0x45cdd1,_0x32bf11={'PsUyP':_0x241a11(0x194),'jcWEF':_0x241a11(0x168),'SOClu':function(_0x533ead,_0xc8e908,_0x47f828,_0x4455dc){return _0x533ead(_0xc8e908,_0x47f828,_0x4455dc);},'linxT':_0x241a11(0x18e),'eQZME':_0x241a11(0x186)},_0x318613=await this.#getBinaryPath(),_0x34215c={};_0x34215c['flags']='a';const _0x4ea04f=fs[_0x241a11(0x19a)](this.#logfile,_0x34215c),_0xd40008=await this[_0x241a11(0x17c)](),_0x570216=await this[_0x241a11(0x18f)]();if(!_0xd40008)return![];const _0xc1b6e1=[(this.#isApp?_0x32bf11[_0x241a11(0x1a7)]:_0x32bf11['jcWEF'])+':start'];_0x570216&&_0xc1b6e1[_0x241a11(0x183)]('-c',_0x570216);this.#proc=_0x32bf11[_0x241a11(0x16b)](spawn,_0x318613,_0xc1b6e1,{'env':Object[_0x241a11(0x191)](process['env'],{'PERCY_TOKEN':_0xd40008,'TH_BUILD_UUID':process[_0x241a11(0x180)][testHubConstants[_0x241a11(0x1ad)][_0x241a11(0x1a0)]]})}),this.#proc[_0x241a11(0x18b)][_0x241a11(0x181)](_0x4ea04f),this.#proc['stderr'][_0x241a11(0x181)](_0x4ea04f),this['isProcessRunning']=!![];var _0x479f56=this;this.#proc['on'](_0x32bf11[_0x241a11(0x187)],function(_0x43cd10){const _0x29b1ee=_0x241a11;_0x479f56[_0x29b1ee(0x173)]=![];});do{const _0x170d00=await this['healthcheck']();if(_0x170d00)return logger[_0x241a11(0x1ac)](_0x32bf11[_0x241a11(0x17e)]),!![];await this.#sleep(0x3e8);}while(this[_0x241a11(0x173)]);return![];}async[a71_0x45cdd1(0x193)](){const _0x18e6c6=a71_0x45cdd1,_0x44265c={'KzhMl':function(_0xc451f2,_0x1828ec){return _0xc451f2(_0x1828ec);},'xVwve':function(_0x411e29,_0x42d3fc,_0x1f923f){return _0x411e29(_0x42d3fc,_0x1f923f);},'zGghQ':_0x18e6c6(0x1a4),'XbctN':'close'},_0x116447=await this.#getBinaryPath();return new Promise((_0x4e5baf,_0xaa70b)=>{const _0x2185ff=_0x18e6c6,_0x4c46f1=_0x44265c[_0x2185ff(0x184)](spawn,_0x116447,[_0x44265c[_0x2185ff(0x1a2)]]);_0x4c46f1['on'](_0x44265c[_0x2185ff(0x16f)],_0x36481f=>{this['isProcessRunning']=![],_0x44265c['KzhMl'](_0x4e5baf,_0x36481f);});});}[a71_0x45cdd1(0x196)](){return this['isProcessRunning'];}async['fetchPercyToken'](){const _0x38bd6b=a71_0x45cdd1,_0xd3f773={};_0xd3f773[_0x38bd6b(0x175)]='app',_0xd3f773['woaWR']=_0x38bd6b(0x163),_0xd3f773[_0x38bd6b(0x19e)]=_0x38bd6b(0x182),_0xd3f773[_0x38bd6b(0x1ab)]='Percy\x20fetch\x20token\x20success';const _0x277344=_0xd3f773,_0x513723=this.#config[_0x38bd6b(0x17b)];try{const _0x5e1e26=this.#isApp?_0x277344[_0x38bd6b(0x175)]:_0x277344[_0x38bd6b(0x164)],_0x411ed4=await helper[_0x38bd6b(0x1a9)](_0x277344['WKSyb'],_0x38bd6b(0x172)+_0x513723+_0x38bd6b(0x16d)+_0x5e1e26,{},this.#config),_0x51db09=_0x411ed4[_0x38bd6b(0x18d)];return logger[_0x38bd6b(0x1ac)](_0x277344[_0x38bd6b(0x1ab)]),_0x51db09['token'];}catch(_0x49790d){return logger[_0x38bd6b(0x178)](_0x38bd6b(0x188)+_0x49790d),null;}}async['createPercyConfig'](){const _0x48daca=a71_0x45cdd1,_0x4f5436={'nuYTa':function(_0x133f62,_0x14172f){return _0x133f62(_0x14172f);},'BFZnr':function(_0x3a3896,_0x53f066){return _0x3a3896+_0x53f066;},'rfzqL':'Percy\x20config\x20created\x20at\x20','LWiPx':function(_0x8a5d2d,_0x4a5cc7){return _0x8a5d2d(_0x4a5cc7);},'KAgnd':_0x48daca(0x1aa)};if(!this.#config['percyOptions'])return null;const _0x1c761e=path['join'](os['tmpdir'](),_0x4f5436[_0x48daca(0x17d)]),_0x1a3a16=this.#config[_0x48daca(0x19c)];return!_0x1a3a16[_0x48daca(0x18a)]&&(_0x1a3a16[_0x48daca(0x18a)]='2'),new Promise((_0x342760,_0x5af79b)=>{const _0x1d4567=_0x48daca;fs[_0x1d4567(0x166)](_0x1c761e,JSON[_0x1d4567(0x177)](_0x1a3a16),_0x2621ad=>{const _0x26ff46=_0x1d4567;_0x2621ad&&(logger['error'](_0x26ff46(0x174)+_0x2621ad),_0x4f5436[_0x26ff46(0x1a1)](_0x342760,null)),logger[_0x26ff46(0x1ac)](_0x4f5436[_0x26ff46(0x176)](_0x4f5436[_0x26ff46(0x19f)],_0x1c761e)),_0x4f5436['LWiPx'](_0x342760,_0x1c761e);});});}}module[a71_0x45cdd1(0x167)]=Percy;function a71_0x466f(){const _0xd76582=['version','stdout','yEcud','data','close','createPercyConfig','app','assign','5582880tfRbci','stop','app:exec','4956748YqgirK','isRunning','458LqzjPU','../helper','start','createWriteStream','path','percyOptions','462GkRdUn','WKSyb','rfzqL','BROWSERSTACK_TESTHUB_UUID','nuYTa','zGghQ','13797WFpHcu','exec:stop','healthcheck','./PercyBinary','PsUyP','elJBe','nodeRequest','percy.json','UMzGp','debug','ENV_VAR','automate','woaWR','PERCY_SERVER_ADDRESS','writeFile','exports','exec','4994TDLRFV','DOWNLOAD','SOClu','3632015PxZGth','&type=','125382LjhiIs','XbctN','percy/healthcheck','child_process','api/app_percy/get_project_token?name=','isProcessRunning','Error\x20creating\x20percy\x20config:\x20','CKNPw','BFZnr','stringify','error','http://localhost:5338','9448CdxRJo','projectName','fetchPercyToken','KAgnd','eQZME','../../helpers/testhub/constants','env','pipe','GET','push','xVwve','../logger','Percy\x20healthcheck\x20successful','linxT','Percy\x20unable\x20to\x20fetch\x20project\x20token:\x20','29138430sqatqm'];a71_0x466f=function(){return _0xd76582;};return a71_0x466f();}